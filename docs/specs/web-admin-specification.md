# TimeLogger Web管理アプリケーション仕様書

## 概要

TimeLogger Web管理アプリケーションは、TimeLogger Discord Bot の管理・監視を行うためのWebベースの管理インターフェースです。Express.js をベースとし、セキュアで直感的な管理機能を提供します。

## システム構成

### 技術スタック
- **サーバー**: Express.js + TypeScript
- **テンプレート**: EJS
- **スタイリング**: Tailwind CSS
- **認証**: Basic認証
- **データベース**: SQLite3（Discord Bot と共有）

### アーキテクチャ
- **MVC パターン**: Routes（Controller）、Services（Model）、Views（EJS）
- **セキュリティレイヤー**: 認証・認可ミドルウェア
- **エラーハンドリング**: 統一エラー処理

## 主要機能

### 1. ダッシュボード機能

#### 1.1 システム状態監視
- **URL**: `/`
- **機能**: 
  - Discord Bot 稼働状況表示
  - データベース接続状態確認
  - 最新の活動ログ表示（直近10件）
  - システムリソース使用状況
- **更新**: リアルタイム更新（30秒間隔）

#### 1.2 利用統計表示
- **ユーザー統計**:
  - 総ユーザー数
  - アクティブユーザー数（直近30日）
  - 新規ユーザー数（直近7日）
- **活動統計**:
  - 総活動ログ数
  - 今日の活動ログ数
  - 直近の活動傾向
- **API統計**:
  - 今日のAPI使用量
  - 月間累計コスト
  - 使用量推移グラフ

### 2. データベース管理機能

#### 2.1 テーブル一覧
- **URL**: `/tables`
- **機能**:
  - 全テーブルの一覧表示
  - 各テーブルのレコード数表示
  - テーブル構造の表示
  - 最終更新日時の表示

#### 2.2 テーブル詳細
- **URL**: `/tables/:tableName`
- **機能**:
  - 指定テーブルの全データ表示
  - ページネーション対応（50件/ページ）
  - データ並び替え機能
  - 検索・フィルタリング機能

#### 2.3 データ操作
- **参照**: 全テーブル・全レコードの閲覧
- **検索**: 複数条件での検索機能
- **エクスポート**: CSV形式でのデータエクスポート
- **制限**: 本番環境では読み取り専用

### 3. TODO管理機能

#### 3.1 TODO一覧
- **URL**: `/todos`
- **機能**:
  - 全ユーザーのTODO一覧表示
  - ステータス別フィルタリング
  - 優先度別並び替え
  - 期日による並び替え
  - ページネーション対応

#### 3.2 TODO作成・編集
- **URL**: `/todos/new`, `/todos/:id/edit`
- **機能**:
  - TODO作成フォーム
  - TODO編集フォーム
  - ステータス変更
  - 優先度設定
  - 期日設定
  - バリデーション機能

#### 3.3 TODO検索・フィルタリング
- **検索条件**:
  - ユーザー別絞り込み
  - ステータス別絞り込み
  - 期日範囲指定
  - キーワード検索
- **並び替え**:
  - 作成日時（昇順・降順）
  - 優先度（高・中・低）
  - 期日（近い順・遠い順）

### 4. 開発・テスト支援機能（非本番環境のみ）

#### 4.1 時刻シミュレーション
- **URL**: `/dev/time-simulation`
- **機能**:
  - 現在時刻の手動設定
  - スケジュール実行の確認
  - タイムゾーン別動作確認
  - 時刻関連処理のテスト

#### 4.2 サマリーテスト
- **URL**: `/dev/summary-test`
- **機能**:
  - 任意のユーザー・日付でのサマリー生成
  - AI分析機能の動作確認
  - 処理時間の測定
  - 結果の詳細表示

#### 4.3 システムテスト
- **API接続テスト**: 外部API（Gemini）の疎通確認
- **データベーステスト**: データベース接続・操作確認
- **Discord Bot テスト**: Bot の応答確認

### 5. セキュリティ機能

#### 5.1 認証・認可
- **認証方式**: Basic認証
- **環境変数**:
  - `ADMIN_USERNAME`: 管理者ユーザー名
  - `ADMIN_PASSWORD`: 管理者パスワード
- **セッション管理**: Express セッションによる認証状態管理

#### 5.2 アクセス制御
- **環境別制御**:
  - **開発環境**: 全機能利用可能
  - **本番環境**: 読み取り専用モード
- **操作制限**:
  - 本番環境でのデータ編集・削除禁止
  - 危険な操作の確認ダイアログ
  - 操作ログの記録

#### 5.3 セキュリティヘッダー
- **X-Content-Type-Options**: MIME タイプ嗅探防止
- **X-Frame-Options**: クリックジャッキング防止
- **X-XSS-Protection**: XSS 攻撃防止
- **Content-Security-Policy**: 各種攻撃の防止

### 6. ユーザーインターフェース

#### 6.1 レスポンシブデザイン
- **モバイルファースト**: スマートフォン対応を優先
- **タブレット対応**: 中間サイズ画面への最適化
- **デスクトップ対応**: 大画面での効率的な表示

#### 6.2 ユーザビリティ
- **直感的なナビゲーション**: 明確な画面遷移
- **視覚的フィードバック**: 操作結果の明確な表示
- **エラーハンドリング**: 分かりやすいエラーメッセージ
- **ローディング表示**: 処理中の状態表示

#### 6.3 アクセシビリティ
- **キーボードナビゲーション**: マウスなしでの操作
- **スクリーンリーダー対応**: 適切なHTML構造
- **色彩配慮**: 色覚障害への配慮
- **フォントサイズ**: 読みやすいフォントサイズ

## 画面仕様

### 1. ダッシュボード画面

#### レイアウト
- **ヘッダー**: サイト名、ナビゲーション、環境表示
- **サイドバー**: 主要機能へのナビゲーション
- **メインコンテンツ**: 統計情報、最新活動ログ
- **フッター**: バージョン情報、リンク

#### 表示内容
- **システム状態**: 
  - Discord Bot 稼働状況（稼働中/停止中）
  - データベース接続状態（接続中/切断中）
  - 最終更新日時
- **利用統計**: 
  - 総ユーザー数、アクティブユーザー数
  - 総活動ログ数、今日の活動ログ数
  - 今日のAPI使用量、月間累計コスト
- **最新活動**: 
  - 直近10件の活動ログ表示
  - ユーザー名、活動内容、時刻
  - 詳細へのリンク

### 2. テーブル管理画面

#### テーブル一覧画面
- **URL**: `/tables`
- **表示内容**:
  - テーブル名、レコード数、最終更新日時
  - 各テーブルへの詳細リンク
  - 検索ボックス
- **機能**:
  - テーブル名での検索
  - レコード数での並び替え
  - 一括エクスポート機能

#### テーブル詳細画面
- **URL**: `/tables/:tableName`
- **表示内容**:
  - テーブル構造の表示
  - データ一覧（ページネーション対応）
  - 検索・フィルタリング機能
- **機能**:
  - 各カラムでの並び替え
  - 複数条件での検索
  - CSVエクスポート
  - データ詳細モーダル

### 3. TODO管理画面

#### TODO一覧画面
- **URL**: `/todos`
- **表示内容**:
  - TODO一覧（ページネーション対応）
  - ステータス別カウント
  - 優先度別色分け
  - 期日による警告表示
- **機能**:
  - ステータス別フィルタリング
  - 優先度別並び替え
  - キーワード検索
  - 一括操作

#### TODO作成・編集画面
- **URL**: `/todos/new`, `/todos/:id/edit`
- **フォーム項目**:
  - TODO内容（必須、テキストエリア）
  - ステータス（選択、デフォルト: pending）
  - 優先度（選択、デフォルト: medium）
  - 期日（日付入力、任意）
  - 関連ユーザー（選択、任意）
- **バリデーション**:
  - 必須項目チェック
  - 文字数制限
  - 日付形式チェック
  - 重複チェック

## API仕様

### 内部API

#### 1. データベース操作API
- **エンドポイント**: 内部関数呼び出し
- **機能**: 
  - テーブル一覧取得
  - テーブル詳細取得
  - データ検索・フィルタリング
  - データ更新（開発環境のみ）

#### 2. TODO管理API
- **エンドポイント**: 内部関数呼び出し
- **機能**:
  - TODO一覧取得
  - TODO作成・更新・削除
  - ステータス変更
  - 検索・フィルタリング

#### 3. 統計情報API
- **エンドポイント**: 内部関数呼び出し
- **機能**:
  - ユーザー統計取得
  - 活動統計取得
  - API使用量統計取得
  - システム状態取得

### 外部API連携

#### 1. Discord Bot API
- **機能**: Bot の状態監視
- **エンドポイント**: 内部プロセス監視
- **データ**: 稼働状況、接続状態

#### 2. データベース API
- **機能**: SQLite データベースへの直接アクセス
- **制限**: 本番環境では読み取り専用
- **セキュリティ**: SQL インジェクション対策

## セキュリティ対策

### 1. 認証・認可
- **認証方式**: Basic認証
- **パスワード**: 環境変数による管理
- **セッション**: Express セッションによる状態管理
- **タイムアウト**: 一定時間での自動ログアウト

### 2. 入力検証
- **バリデーション**: 全入力値の検証
- **サニタイゼーション**: XSS 対策
- **SQLインジェクション**: パラメータ化クエリ
- **CSRF**: CSRFトークンによる保護

### 3. データ保護
- **暗号化**: 機密データの暗号化
- **アクセスログ**: 全アクセスの記録
- **エラーハンドリング**: 情報漏洩防止
- **権限管理**: 最小権限の原則

### 4. 通信セキュリティ
- **HTTPS**: 本番環境での必須
- **セキュリティヘッダー**: 各種攻撃の防止
- **CORS**: 適切なCORS設定
- **レート制限**: DDoS攻撃対策

## パフォーマンス最適化

### 1. データベース最適化
- **インデックス**: 適切なインデックス設定
- **クエリ最適化**: 効率的なSQL文
- **コネクションプール**: 接続の最適化
- **キャッシュ**: 頻繁なクエリの結果キャッシュ

### 2. フロントエンド最適化
- **静的ファイル**: 効率的なキャッシュ設定
- **画像最適化**: 適切な画像形式・サイズ
- **CSS/JS**: 最小化・圧縮
- **レンダリング**: 効率的なDOM操作

### 3. サーバー最適化
- **メモリ使用量**: 効率的なメモリ管理
- **CPU使用率**: 非同期処理の活用
- **ネットワーク**: 効率的なデータ転送
- **ログ**: 適切なログレベル設定

## 運用・監視

### 1. ログ管理
- **アクセスログ**: 全HTTPリクエストの記録
- **エラーログ**: エラー発生時の詳細記録
- **操作ログ**: データ変更操作の記録
- **パフォーマンスログ**: 処理時間の記録

### 2. 監視項目
- **稼働状況**: サーバーの稼働監視
- **リソース使用量**: CPU、メモリ、ディスク使用量
- **レスポンス時間**: 画面表示速度の監視
- **エラー率**: エラー発生率の監視

### 3. バックアップ・復旧
- **定期バックアップ**: データベースの定期バックアップ
- **設定バックアップ**: 設定ファイルのバックアップ
- **復旧手順**: 障害時の復旧手順書
- **テスト**: 復旧テストの定期実行

## 開発・テスト

### 1. 開発環境
- **ローカル開発**: `npm run admin:dev`
- **ホットリロード**: ファイル変更時の自動再読み込み
- **デバッグ**: 詳細なログ出力
- **テストデータ**: 開発用テストデータ

### 2. テスト戦略
- **単体テスト**: 各関数・メソッドのテスト
- **統合テスト**: API・データベース連携テスト
- **E2Eテスト**: 画面操作のテスト
- **セキュリティテスト**: 脆弱性テスト

### 3. 品質保証
- **コードレビュー**: プルリクエストによるレビュー
- **静的解析**: TypeScript、ESLint
- **テストカバレッジ**: 十分なテストカバレッジ
- **パフォーマンステスト**: 負荷テスト

## 環境構成

### 1. 開発環境
- **URL**: http://localhost:3001
- **機能**: 全機能利用可能
- **データ**: 開発用データベース
- **セキュリティ**: 開発用設定

### 2. Staging環境
- **URL**: https://timelogger-staging.fly.dev
- **機能**: 本番環境と同等
- **データ**: テスト用データベース
- **セキュリティ**: 本番環境と同等

### 3. Production環境
- **URL**: https://timelogger-bitter-resonance-9585.fly.dev
- **機能**: 読み取り専用モード
- **データ**: 本番データベース
- **セキュリティ**: 最高レベル

## 制限事項・注意事項

### 1. 技術的制限
- **SQLite**: 同時接続数の制限
- **メモリ**: 大量データ処理時のメモリ使用
- **パフォーマンス**: 大量データでの表示速度

### 2. 運用上の制限
- **本番環境**: 読み取り専用モード
- **認証**: 単一ユーザーでの運用
- **バックアップ**: 手動バックアップ

### 3. セキュリティ上の注意
- **パスワード**: 強力なパスワードの設定
- **HTTPS**: 本番環境でのHTTPS必須
- **アクセス制御**: 適切なアクセス制御

## 今後の改善予定

### 1. 機能拡張
- **ユーザー管理**: 複数ユーザーでの管理
- **権限管理**: 役割別アクセス制御
- **通知機能**: 重要イベントの通知
- **レポート機能**: 詳細なレポート生成

### 2. 技術改善
- **認証**: OAuth2.0、JWT認証
- **データベース**: PostgreSQL対応
- **キャッシュ**: Redis導入
- **監視**: APM ツール導入

### 3. UI/UX改善
- **ダークモード**: ダークテーマ対応
- **多言語**: 英語等の多言語対応
- **アクセシビリティ**: より高いアクセシビリティ
- **モバイルアプリ**: ネイティブアプリ対応

---

**バージョン**: 1.0.0  
**最終更新**: 2025-07-18  
**作成者**: TimeLogger 開発チーム