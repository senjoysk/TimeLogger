# TimeLogger Discord Bot サービス仕様書

## 概要

TimeLoggerは、Discord Bot を中心とした包括的なタスク管理・時間追跡システムです。AI分析によるリアルタイム活動分析、多言語対応、自動スケジューリング、Web管理インターフェースなど、豊富な機能を提供します。

## システムアーキテクチャ

### コア構成
- **Discord Bot**: メインのユーザーインターフェース
- **AI分析エンジン**: Google Gemini 2.0 Flash による自然言語処理
- **データベース**: SQLite3 による永続化
- **Web管理**: Express.js ベースの管理インターフェース
- **スケジューラー**: node-cron による定期実行

### 技術スタック
- **言語**: Node.js + TypeScript
- **Discord**: discord.js v14
- **AI**: Google Gemini 2.0 Flash
- **データベース**: SQLite3
- **Web**: Express.js + EJS + Tailwind CSS
- **テスト**: Jest (45.5% カバレッジ)

## 機能仕様

### 1. 活動ログ管理機能

#### 1.1 リアルタイム活動分析
- **機能**: ユーザーの Discord メッセージを AI で分析し、活動内容を自動抽出
- **AI分析項目**:
  - 活動内容の自然言語分析
  - 開始・終了時刻の抽出
  - 活動カテゴリの自動分類
  - 分析結果の信頼度評価
- **対応形式**: 自然言語での活動報告
- **例**: "今日は9時から12時まで資料作成をしました" → 開始時刻: 09:00, 終了時刻: 12:00, 内容: 資料作成

#### 1.2 活動ログ CRUD 操作
- **作成**: リアルタイム分析による自動生成
- **読み取り**: 日付・キーワード検索、ページネーション対応
- **更新**: `!edit` コマンドによる後編集
- **削除**: 論理削除による安全な削除

#### 1.3 活動ログ検索機能
- **日付指定検索**: 特定日の活動ログ表示
- **キーワード検索**: 活動内容での部分一致検索
- **ページネーション**: 大量データの効率的表示

### 2. Discord Bot コマンド機能

#### 2.1 基本コマンド

##### `!summary [日付]`
- **機能**: AI分析による日次サマリー生成
- **パラメータ**: 
  - 日付（省略時は今日）
  - `--no-cache`: キャッシュ無視での再分析
- **出力**: 
  - 活動サマリー
  - TODO進捗状況
  - 効率性分析
  - 改善提案

##### `!cost [日付|月]`
- **機能**: API コスト監視レポート
- **パラメータ**:
  - 日付（省略時は今日）
  - `month`: 月次集計
- **出力**:
  - トークン使用量
  - 推定コスト
  - 月次比較

##### `!edit [ID]`
- **機能**: 活動ログ編集
- **パラメータ**: 活動ログID
- **操作**:
  - 内容編集
  - 時刻修正
  - 削除（論理削除）

##### `!logs [日付] [キーワード]`
- **機能**: 活動ログ検索・表示
- **パラメータ**:
  - 日付（省略時は今日）
  - キーワード（部分一致検索）
- **出力**: ページネーション対応リスト

##### `!timezone [タイムゾーン]`
- **機能**: タイムゾーン管理
- **パラメータ**: タイムゾーン名（省略時は現在設定表示）
- **操作**:
  - 現在設定確認
  - タイムゾーン変更
  - 利用可能リスト表示

#### 2.2 拡張コマンド

##### `!todo [操作] [内容]`
- **機能**: TODO管理
- **操作**:
  - `add`: TODO追加
  - `list`: TODO一覧表示
  - `done [ID]`: TODO完了
  - `edit [ID]`: TODO編集
  - `delete [ID]`: TODO削除
- **パラメータ**:
  - 内容、優先度、期日設定
  - 活動ログとの関連付け

##### `!memo [操作] [内容]`
- **機能**: メモ管理
- **操作**:
  - `add`: メモ追加
  - `list`: メモ一覧
  - `search [キーワード]`: メモ検索
  - `delete [ID]`: メモ削除
- **機能**: タグ付け、検索機能

##### `!gap [日付]`
- **機能**: 活動ギャップ検出
- **パラメータ**: 対象日付
- **出力**: 活動間の空白時間レポート

##### `!profile`
- **機能**: ユーザープロフィール表示
- **出力**:
  - ユーザー設定情報
  - 利用統計
  - 活動傾向分析

### 3. AI分析機能

#### 3.1 自然言語処理エンジン
- **AI モデル**: Google Gemini 2.0 Flash
- **処理内容**:
  - 活動内容の意味解析
  - 時間情報の抽出
  - 活動カテゴリの自動分類
  - 信頼度評価

#### 3.2 統合分析サービス
- **活動-TODO相関分析**: 活動ログとTODOの関連性分析
- **効率性分析**: 作業効率の定量的評価
- **パフォーマンス分析**: 時間配分の最適化提案
- **ギャップ検出**: 作業の抜け漏れ検出

#### 3.3 分析結果キャッシュ
- **キャッシュ戦略**: 日次分析結果の永続化
- **無効化機能**: 手動でのキャッシュ更新
- **パフォーマンス最適化**: 重い分析処理の高速化

### 4. 自動スケジューリング機能

#### 4.1 動的スケジューリング
- **EnhancedScheduler**: 高度なスケジューリング機能
- **DynamicReportScheduler**: ユーザー別タイムゾーン対応
- **TimezoneChangeMonitor**: タイムゾーン変更監視

#### 4.2 定期実行タスク
- **日次サマリー配信**: 
  - 実行時刻: 18:30（各ユーザーのタイムゾーン）
  - 内容: AI分析による包括的日次レポート
  - 配信条件: アクティブユーザーのみ

- **APIコストレポート**:
  - 実行時刻: 18:05（日次）
  - 内容: トークン使用量、推定コスト
  - 警告機能: 閾値超過時の自動通知

### 5. データベース設計

#### 5.1 テーブル構成

##### activity_logs（活動ログ）
- `id`: 主キー
- `user_id`: Discord ユーザーID
- `content`: 活動内容
- `timestamp`: 作成日時
- `start_time`: 開始時刻
- `end_time`: 終了時刻
- `confidence`: AI分析信頼度
- `category`: 活動カテゴリ
- `is_deleted`: 削除フラグ

##### user_settings（ユーザー設定）
- `user_id`: Discord ユーザーID（主キー）
- `timezone`: タイムゾーン
- `username`: ユーザー名
- `first_activity_date`: 初回利用日
- `last_activity_date`: 最終利用日
- `is_active`: アクティブ状態

##### todo_tasks（TODO管理）
- `id`: 主キー
- `user_id`: Discord ユーザーID
- `content`: TODO内容
- `status`: ステータス（pending, in_progress, completed, cancelled）
- `priority`: 優先度（high, medium, low）
- `due_date`: 期日
- `created_at`: 作成日時
- `updated_at`: 更新日時

##### api_costs（APIコスト監視）
- `id`: 主キー
- `user_id`: Discord ユーザーID
- `operation_type`: 操作種別
- `input_tokens`: 入力トークン数
- `output_tokens`: 出力トークン数
- `estimated_cost`: 推定コスト
- `timestamp`: 実行日時
- `business_date`: 業務日

##### daily_analysis_cache（分析キャッシュ）
- `id`: 主キー
- `user_id`: Discord ユーザーID
- `date`: 対象日付
- `analysis_result`: 分析結果（JSON）
- `log_count`: 対象ログ数
- `generated_at`: 生成日時

#### 5.2 インデックス設計
- `activity_logs`: user_id, timestamp, business_date
- `api_costs`: user_id, timestamp, business_date
- `todo_tasks`: user_id, status, due_date
- `daily_analysis_cache`: user_id, date

### 6. セキュリティ・エラーハンドリング

#### 6.1 統一エラーハンドリング
- **AppError**: 統一エラークラス
- **withErrorHandling**: エラーハンドリング装飾関数
- **ActivityLogError**: 活動ログ専用エラー

#### 6.2 データ保護
- **論理削除**: 物理削除を避けた安全な削除
- **バックアップ**: 定期的なデータバックアップ
- **APIキー管理**: 環境変数による秘密情報管理

#### 6.3 パフォーマンス最適化
- **クエリ最適化**: インデックスを活用した高速検索
- **キャッシュ機能**: 重い分析処理の結果キャッシュ
- **ページネーション**: 大量データの効率的表示

### 7. 多言語・国際化対応

#### 7.1 タイムゾーン対応
- **動的タイムゾーン**: ユーザー個別のタイムゾーン設定
- **自動配信**: タイムゾーン別の自動レポート配信
- **時刻表示**: ローカル時刻での表示

#### 7.2 日本語対応
- **自然言語処理**: 日本語での活動内容分析
- **UI**: 日本語でのコマンド応答
- **レポート**: 日本語での分析結果表示

### 8. 運用・監視

#### 8.1 ヘルスチェック
- **システム状態監視**: Bot稼働状況、データベース接続状態
- **API監視**: 外部API（Gemini）の応答状況
- **自動復旧**: 障害時の自動復旧機能

#### 8.2 ログ・監査
- **操作ログ**: 全コマンド実行履歴
- **エラーログ**: システムエラーの詳細記録
- **利用統計**: ユーザー別利用状況の分析

## 環境構成

### 開発環境
- **用途**: TDD開発、単体テスト、機能実装
- **データベース**: ローカル SQLite
- **デバッグ**: 詳細ログ出力、自動リロード

### Staging環境
- **用途**: fly.io での統合テスト、本番前検証
- **URL**: https://timelogger-staging.fly.dev
- **データベース**: 分離DB + テストデータ
- **デプロイ**: 手動デプロイ（マシン自動復旧機能付き）

### Production環境
- **用途**: 実際の Discord Bot 運用
- **URL**: https://timelogger-bitter-resonance-9585.fly.dev
- **データベース**: 本番データ
- **デプロイ**: main ブランチ push による自動デプロイ

## API仕様

### 内部API
- **Discord Bot**: discord.js v14 による Discord API 連携
- **AI分析**: Google Gemini 2.0 Flash API
- **データベース**: 直接 SQLite3 アクセス

### 外部連携
- **Discord API**: メッセージ送受信、ユーザー情報取得
- **Google Gemini API**: 自然言語処理、分析機能
- **fly.io API**: デプロイメント、ヘルスチェック

## 制限事項・注意事項

### 技術的制限
- **SQLite**: 同時接続数の制限（実用上問題なし）
- **メモリ**: 大量データ処理時のメモリ使用量
- **API制限**: Google Gemini 2.0 Flash API の利用制限

### 運用上の注意
- **コスト監視**: AI分析による従量課金コストの監視
- **データ保護**: 個人情報を含む活動ログの適切な管理
- **可用性**: 24/7 運用での安定性確保

## 今後の拡張計画

### 機能拡張
- **分析機能強化**: より詳細な効率性分析
- **連携機能**: 外部ツール（Google Calendar、Slack等）との連携

### 技術改善
- **スケーラビリティ**: PostgreSQL への移行検討
- **キャッシュ**: Redis 導入による高速化
- **監視強化**: APM ツールの導入

---

**バージョン**: 1.0.0  
**最終更新**: 2025-07-18  
**作成者**: TimeLogger 開発チーム