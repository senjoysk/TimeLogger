# タイムゾーン設定時の重複メッセージ問題 - 修正レポート

## 問題の概要

`!timezone set Asia/Kolkata`コマンドを実行した際に、同じメッセージが3回送信される問題が発生した。

## 原因

複数のTimeLoggerBotプロセスが同時に実行されていたため、同じDiscordイベントを複数のプロセスが処理してしまった。

### 確認されたプロセス
- プロセスID 68022: `node dist/index.js`
- プロセスID 92018: `node dist/index.js` 
- プロセスID 93914: `node /Users/senjo.yoshiki/Work/senjoysk/TimeLogger/node_modules/.bin/ts-node src/index.ts`

## 原因の詳細

1. **開発中の重複起動**: 開発・テスト中に複数回Botを起動してしまい、前のプロセスが適切に終了していなかった
2. **プロセス管理不備**: 既存プロセスの確認なしに新しいプロセスを起動していた
3. **Discord接続の重複**: 同じBot Token で複数のプロセスが Discord に接続していた

## 解決策

1. **全プロセス停止**: `pkill -f "TimeLogger"` および `pkill -f "node.*dist/index.js"` で全関連プロセスを停止
2. **単一プロセス起動**: 1つのプロセスのみを起動し、複数起動を防止
3. **プロセス確認**: 起動前に既存プロセスがないことを確認

## 予防策の提案

### 1. プロセス管理の改善
- 起動前の既存プロセス確認
- PIDファイルによる重複起動防止
- グレースフル・シャットダウンの徹底

### 2. 開発ワークフローの改善
```bash
# 起動前の確認コマンド
npm run stop  # 既存プロセス停止
npm run start # 新プロセス起動
```

### 3. 監視・ログ改善
- プロセスID のログ出力
- 複数接続の検出・警告
- 起動時の重複チェック

## 修正後の確認

✅ **単一プロセス動作**: 1つのBotプロセスのみが実行中  
✅ **タイムゾーン設定正常**: Asia/Kolkata に正しく設定  
✅ **メッセージ重複解消**: 1回のコマンドで1回のレスポンス  
✅ **スケジューラー正常**: ユーザータイムゾーンに基づいた動作  

## 教訓

1. **開発時のプロセス管理**: 新しいプロセス起動前に既存プロセスの停止を徹底
2. **複数インスタンス対策**: Bot アプリケーションでは特に重複起動防止が重要
3. **ログ監視**: 予期しない動作の早期発見のためのログ監視の重要性

修正完了日: 2025-06-26