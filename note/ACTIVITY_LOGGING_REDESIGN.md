# 活動記録システム再設計：30分スロット制約撤廃

**作成日**: 2025-06-29  
**対象**: TimeLogger Discord Bot  
**変更タイプ**: 主要仕様変更

## 📋 変更概要

### 旧仕様の課題
- **30分タイムスロット制約**: すべての活動が30分単位で強制的に区切られる
- **柔軟性の欠如**: ユーザーの自然な活動パターンに対応できない
- **時刻指定の複雑さ**: 「14:00-15:30は会議」のような入力が複雑な処理を要求
- **編集の困難さ**: スロット単位での編集のため、直感的でない

### 新仕様のメリット
- **自然言語重視**: ユーザーの入力をそのまま記録・保持
- **柔軟な時間表現**: 相対時刻（「いま30分」）も絶対時刻（「14:00-15:30」）も対応
- **簡潔な編集**: 1投稿=1レコードで編集が直感的
- **正確な分析**: LLMが全文脈を考慮した時間配分分析

## 🔄 仕様変更詳細

### 記録方式の変更

#### **Before: 30分スロット方式**
```
ユーザー入力: "14:00-15:30は会議でした"
→ 処理: 3つの30分スロットに分割
→ 保存: 14:00-14:30, 14:30-15:00, 15:00-15:30
→ 問題: 分割による情報の断片化
```

#### **After: 自然言語ログ方式**
```
ユーザー入力: "14:00-15:30は会議でした"
→ 処理: 入力時刻と内容をそのまま記録
→ 保存: content="14:00-15:30は会議でした", input_timestamp="2025-06-29T10:00:00Z"
→ 分析: LLMが全体を見て時間配分を判断
```

### データベース設計変更

#### **新テーブル構造**
```sql
-- メインの活動ログ
CREATE TABLE activity_logs (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    content TEXT NOT NULL,           -- ユーザーの生入力
    input_timestamp TEXT NOT NULL,  -- 入力時刻（UTC）
    business_date TEXT NOT NULL,    -- 業務日（5am基準）
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TEXT NOT NULL,
    updated_at TEXT NOT NULL
);

-- 分析結果キャッシュ
CREATE TABLE daily_analysis_cache (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    business_date TEXT NOT NULL,
    analysis_result TEXT NOT NULL,  -- JSON形式
    log_count INTEGER NOT NULL,
    generated_at TEXT NOT NULL,
    UNIQUE(user_id, business_date)
);
```

#### **旧テーブルとの比較**
| 項目 | 旧: activity_records | 新: activity_logs |
|------|---------------------|-------------------|
| 記録単位 | 30分スロット | 1投稿 |
| 時刻情報 | time_slot (スロット開始時刻) | input_timestamp (実際の入力時刻) |
| 内容 | original_text + 解析結果 | content (生入力のみ) |
| 分析 | リアルタイム分析・保存 | キャッシュ方式 |

## 🚀 新機能

### 1. **柔軟な編集機能**
```
!edit                    # 今日のログ一覧表示（ID付き）
!edit 3 新しい内容        # ログID:3を更新
!edit delete 5          # ログID:5を削除
```

### 2. **リアルタイム分析**
```
!summary                 # 今日の途中経過分析
!summary 2025-06-27     # 指定日分析
```

### 3. **スマートなトークン管理**
- 1日のログが長い場合、時間帯別に分割して分析
- 重要度に応じてログを重み付け
- 段階的要約で最終統合

### 4. **時刻表現の自動解釈**
| 入力例 | LLMによる解釈 |
|--------|---------------|
| "いま30分会議していた" | input_timestamp基準で30分前〜現在 |
| "14:00-15:30は会議でした" | 明示的な時刻範囲 |
| "午前中ずっとプログラミング" | 9:00-12:00の推定 |
| "さっき休憩した" | input_timestamp基準で直近の推定時間 |

## 📊 分析方式の変更

### **Before: リアルタイム分析**
- 投稿ごとにGemini API呼び出し
- 30分スロットに強制分割
- 個別の分析結果をDB保存

### **After: バッチ分析 + キャッシュ**
- 分析は要求時 (!summary) またはバッチ処理時 (5am)
- 1日分のログを統合してLLMに送信
- 分析結果をキャッシュして高速レスポンス

### **分析プロンプト例**
```
以下は1日の活動ログです。時間配分を分析してください：

【入力ログ】
10:30 投稿: "14:00-15:30は会議でした"
16:00 投稿: "いま30分休憩していた"
18:00 投稿: "午後はずっとプログラミング"

【分析要求】
1. 各活動の推定時間範囲
2. カテゴリ別時間集計
3. 重複・未記録時間の検出
4. 生産性評価
```

## 🔧 実装計画

### **Phase 1: データ基盤構築**
1. 新テーブル作成
2. 既存データの移行スクリプト
3. 新Repository層の実装

### **Phase 2: 機能実装**
1. 新ActivityLogService実装
2. 編集機能 (!edit) 実装
3. リアルタイム分析 (!summary) 実装
4. スマートな分析エンジン実装

### **Phase 3: 移行・最適化**
1. 旧30分スロット関連コード削除
2. パフォーマンス最適化
3. UI/UX改善

## 📈 期待される改善効果

### **ユーザビリティ**
- 自然な入力方式で記録ストレスが軽減
- 直感的な編集機能で修正が容易
- リアルタイム分析で途中経過確認が可能

### **データ精度**
- LLMによる文脈を考慮した時間推定
- 重複時間の自動検出・調整
- より正確な生産性評価

### **システム性能**
- API呼び出し頻度の最適化
- キャッシュによる高速レスポンス
- スケーラブルな分析処理

## 🚨 注意事項・リスク

### **技術的リスク**
- LLMトークン制限への対応が必要
- 分析精度のLLM依存度が高い
- 既存データ移行の複雑性

### **ユーザー影響**
- 既存の使用パターンの変更が必要
- 分析結果の表示形式変更
- コマンド体系の一部変更

### **運用面**
- 分析処理時間の増加可能性
- API使用量の変動
- デバッグ・トラブルシューティングの複雑化

---

**この再設計により、TimeLogger は真に「自然な活動記録」を実現し、ユーザーの生産性向上により貢献できるシステムに進化します。**