# 要件定義: AIタイムロガーBot

## 1. 概要 (Overview)

本プロジェクトは、DiscordをインターフェースとするAI Botを開発する。ユーザーは自然言語での対話を通じて、自身の活動を手軽に記録できる。Botはユーザーの発言を解釈し、適切な時間軸に活動内容を整理・記録し、日々の生産性向上を支援する。

## 2. 機能要件 (Functional Requirements)

### 2.1 自然言語による活動記録

### 2.5 タイムゾーン対応 (Timezone Support)

ユーザーの利便性を高めるため、Botはタイムゾーンを意識した活動記録とサマリー生成をサポートする。

-   **ユーザーごとのタイムゾーン設定**:
    -   ユーザーは専用のコマンドユーザーは専用のコマンド（例: `!timezone Asia/Tokyo`）を用いて自身のタイムゾーンを設定できる。
    -   設定されたタイムゾーンは永続化され、以降の活動記録、リマインダー、サマリー生成に適用される。
    -   タイムゾーンが未設定の場合、Botはデフォルトのタイムゾーン（例: JST）を使用する。
-   **タイムゾーン変更のハンドリング**:
    -   ユーザーがタイムゾーンを変更した場合、過去の活動記録は元のタイムゾーンで保持される。
    -   リマインダーや日次サマリーの生成時刻は、変更後のタイムゾーンに基づいて調整される。
    -   AIによる時間解釈（例: 「今」「さっき」）は、常にユーザーの現在の設定タイムゾーンを基準に行われる。
-   **リマインダーとサマリーの調整**:
    -   リマインダー（2.2）および日次サマリー（2.3）の実行タイミングは、ユーザーのタイムゾーン設定に基づいて調整される。例えば、ユーザーがタイムゾーンをJSTからPSTに変更した場合、リマインダーやサマリーの時刻もPSTの9:00-18:00、18:00に調整される。
-   **表示の統一**:
    -   Botがユーザーに提示する時刻情報（リマインダー、サマリー、活動記録の確認メッセージなど）は、常にユーザーの現在の設定タイムゾーンで表示される。

### 2.1 自然言語による活動記録

ユーザーからの自由な形式のテキストメッセージをAIが解釈し、活動を記録する。

-   **入力**: DiscordのDMでの自由なテキストメッセージ（定期リマインダーへの返信、または任意タイミングでの投稿）。
-   **AIによる解釈**:
    -   **時間情報の抽出**: ユーザーの発言に含まれる時間表現（例: 「今」「さっき」「15分前」「14時から15時まで」）をAIが認識し、具体的な日時にマッピングする。
    -   **活動内容の抽出**: ユーザーが「何をしたか」をテキストから抽出する。
    -   **入力時刻の保持**: メッセージの投稿時刻を記録し、相対的時間表現（「いま30分」など）の解釈に活用する。
-   **記録方式**: 
    -   **自然言語ログ方式**: ユーザーの入力をそのまま保持し、分析時に全体を統合してAIが時間配分を判断する。
    -   **1投稿=1レコード**: 各投稿を個別のレコードとして保存し、編集・削除を容易にする。
-   **記録の柔軟性**:
    -   **リアルタイム記録**: 「今から〇〇する」「〇〇始めます」といった発言を記録。
    -   **事後記録**: 「さっきは〇〇してた」「1時間前は△△」といった過去の活動を記録。
    -   **範囲指定記録**: 「14:00-15:30は会議」のように時間範囲を明示的に指定。
    -   **相対時間記録**: 「いま30分会議していた」のような相対的な時間表現を入力時刻から推定。
-   **対話例**:
    -   `User: "今から設計作業に入ります"` -> 内容と入力時刻を記録、分析時に活動開始時刻として解釈。
    -   `User: "いま30分メール対応していた"` -> 入力時刻から30分前〜現在の活動として解釈。
    -   `User: "14時から15時30分までA社と打ち合わせでした"` -> 明示的な時間範囲として記録。
    -   `User: "午前中ずっとプログラミング"` -> AIが午前中（9:00-12:00頃）と推定して記録。

### 2.2 定期的な活動記録の促進 (リマインダー)

-   **目的**: ユーザーに活動記録を促し、記録漏れを防ぐ。
-   **実行タイミング**: 平日の9:00から18:00まで、毎時0分と30分。
-   **実行内容**: ユーザーへのDMで「この30分間なにしてた？」といった形式で問いかける（活動記録の入力催促として機能）。
-   **レスポンス処理**: ユーザーの返信は自然言語ログとして記録され、特別な制約や形式は要求しない。

### 2.3 日次サマリー

一日の活動を振り返るためのサマリーを生成する。

-   **生成タイミング**:
    -   **定時生成**: 毎日午前5:00に前日（午前5:00〜翌日午前4:59）の活動サマリーを自動でDMに送信する。
    -   **リアルタイム生成**: ユーザーが`!summary`コマンドを送信することで、その日の現在までの活動状況をいつでも確認できる。
    -   **過去日指定**: `!summary 2025-06-27`形式で過去の特定日のサマリーを生成可能。
-   **分析方式**:
    -   **統合分析**: その日の全活動ログ（自然言語）をAIが統合的に分析し、時間配分とカテゴリ分類を実行。
    -   **キャッシュ機能**: 分析結果はキャッシュされ、同じ日の再要求時は高速レスポンスを実現。
    -   **スマートトークン管理**: 1日のログが長い場合、時間帯別分割分析を実行して最終統合。
-   **サマリー内容**:
    -   **活動カテゴリ別の時間集計**: AIが活動内容を動的にカテゴリ分類（例: 会議、開発、休憩）し、推定時間を集計表示。
    -   **タイムライン**: 主要活動の時系列表示。
    -   **重複・未記録時間の検出**: AIが時間の重複や記録漏れを検出・指摘。
    -   **AIによる所感**: その日の活動内容全体を基に、AIが労いの言葉や簡単な感想を生成。
    -   **AIによるポジティブな一言**: 明日に向けた前向きなメッセージをAIが生成。
-   **一日の区切り**: 1日の区切りは午前5:00から翌日の午前4:59までとする。

### 2.4 データ管理

-   **データ永続化**: 記録された活動データは永続的に保存される。
-   **データアクセス**: データはユーザーごとに完全に分離され、本人のみがアクセス可能。
-   **データ構造**:
    -   **活動ログテーブル**: 1投稿=1レコードとして、ユーザーの生入力、入力時刻、業務日を記録。
    -   **分析キャッシュテーブル**: 日次分析結果をキャッシュし、高速なサマリー表示を実現。
-   **編集・削除機能**:
    -   **活動ログの編集**: `!edit`コマンドでその日のログ一覧を表示し、ID指定で編集可能。
    -   **活動ログの削除**: `!edit delete <ID>`形式で不要なログを削除可能。
    -   **論理削除**: データは物理削除せず、フラグによる論理削除で履歴を保持。

## 3. 非機能要件 (Non-functional Requirements)

-   **可用性**: Botは24時間365日稼働していること。
-   **応答性能**: ユーザーからのメッセージに対して、Botは迅速に応答を返すこと。
-   **プライバシー**: ユーザーの活動記録は機密情報として扱い、本人以外は閲覧できないことを保証する。

## 4. 将来的な拡張要件 (Future Enhancements)

-   **高度な時間表現の解釈**: 「昨日の午後」「今週の月曜日」といった、より曖昧な時間表現の解釈。
-   **集計期間の拡張**: 週次・月次でのサマリー機能。
-   **可視化**: 活動記録をグラフなどで可視化する機能。
-   **外部連携**: Google Calendarなど、外部サービスとの連携機能。
-   **マルチユーザー対応**: 複数人での利用やチームでの利用。
-   **AI分析の高度化**: 活動パターンの学習、生産性向上の提案、異常検知など。
-   **バルク操作**: 複数日・複数ログの一括編集・削除機能。

## 5. 技術スタック (Technology Stack)

-   **言語**: Node.js + TypeScript
-   **Discord連携**: discord.js
-   **AI/LLM**: Google Gemini API
-   **データベース**: SQLite (初期)
-   **スケジューラー**: node-cron