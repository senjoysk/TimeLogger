# Stagingç’°å¢ƒå“è³ªãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# develop ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´æ™‚ã«å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§æ‰‹å‹•å®Ÿè¡Œï¼‰

name: Staging Quality Check
on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç·Šæ€¥æ™‚ã®ã¿ï¼‰'
        required: false
        default: false
        type: boolean
      environment:
        description: 'ãƒ†ã‚¹ãƒˆç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - 'staging'

# æ³¨æ„: ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§æ‰‹å‹•å®Ÿè¡Œã—ã¦ãã ã•ã„
# å®Ÿè¡Œæ–¹æ³•: ./scripts/staging/deploy-to-staging.sh

jobs:
  quality-check:
    runs-on: ubuntu-latest
    name: å“è³ªãƒã‚§ãƒƒã‚¯
    outputs:
      build-success: ${{ steps.build.outputs.success }}
      test-success: ${{ steps.test.outputs.success }}
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ğŸ—ï¸ TypeScriptãƒ“ãƒ«ãƒ‰
        id: build
        run: |
          npm run build
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        id: test
        if: github.event.inputs.skip_tests != 'true'
        run: |
          npm test
          npm run test:integration
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
        if: github.event.inputs.skip_tests != 'true'
        run: npm run test:coverage

  manual-deploy-guide:
    needs: quality-check
    if: needs.quality-check.outputs.build-success == 'true'
    runs-on: ubuntu-latest
    name: æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰
    
    steps:
      - name: ğŸ“Š å“è³ªãƒã‚§ãƒƒã‚¯å®Œäº†é€šçŸ¥
        run: |
          echo "âœ… å“è³ªãƒã‚§ãƒƒã‚¯ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "======================================"
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸ• ãƒã‚§ãƒƒã‚¯æ™‚åˆ»: $(date)"
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ: ${{ needs.quality-check.outputs.test-success == 'true' && 'âœ… æˆåŠŸ' || 'âš ï¸ ã‚¹ã‚­ãƒƒãƒ—' }}"
          echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰çµæœ: ${{ needs.quality-check.outputs.build-success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}"
          echo ""
          echo "ğŸ“ æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ãŒæ•´ã„ã¾ã—ãŸï¼"
          
      - name: ğŸ’¡ æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰
        run: |
          echo ""
          echo "ğŸš€ Stagingç’°å¢ƒã¸ã®æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•:"
          echo "======================================"
          echo ""
          echo "1. ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ–ãƒ©ãƒ³ãƒã‚’pull:"
          echo "   git checkout develop"
          echo "   git pull origin develop"
          echo ""
          echo "2. Stagingç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤:"
          echo "   ./scripts/staging/deploy-to-staging.sh"
          echo ""
          echo "3. ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèª:"
          echo "   - Stagingç’°å¢ƒURL: https://timelogger-staging.fly.dev"
          echo "   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: https://timelogger-staging.fly.dev/health"
          echo ""
          echo "4. å‹•ä½œãƒ†ã‚¹ãƒˆ:"
          echo "   - Discord Bot ã®åŸºæœ¬å‹•ä½œ"
          echo "   - !cost, !summary, !timezone ã‚³ãƒãƒ³ãƒ‰"
          echo ""
          echo "5. å•é¡Œãªã‘ã‚Œã° main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸"
          echo "   â†’ Productionç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤"
          echo ""
          echo "âš ï¸ æ³¨æ„: GitHub Actionsã‹ã‚‰ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ç„¡åŠ¹åŒ–ã•ã‚Œã¦ã„ã¾ã™"