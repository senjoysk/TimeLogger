# Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# develop ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´ã‚’ staging ç’°å¢ƒã«è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤

name: Staging Deploy
on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç·Šæ€¥æ™‚ã®ã¿ï¼‰'
        required: false
        default: false
        type: boolean
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'staging'
        type: choice
        options:
          - 'staging'

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  STAGING_APP_NAME: timelogger-staging

jobs:
  quality-check:
    runs-on: ubuntu-latest
    name: å“è³ªãƒã‚§ãƒƒã‚¯
    outputs:
      build-success: ${{ steps.build.outputs.success }}
      test-success: ${{ steps.test.outputs.success }}
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ğŸ—ï¸ TypeScriptãƒ“ãƒ«ãƒ‰
        id: build
        run: |
          npm run build
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        id: test
        if: github.event.inputs.skip_tests != 'true'
        run: |
          npm test
          npm run test:integration
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
        if: github.event.inputs.skip_tests != 'true'
        run: npm run test:coverage

  deploy-staging:
    needs: quality-check
    if: needs.quality-check.outputs.build-success == 'true'
    runs-on: ubuntu-latest
    environment: staging
    name: Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤
    
    steps:
      - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒç¢ºèª
        run: |
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ğŸ§ª ç’°å¢ƒ: staging"
          echo "ğŸ“± ã‚¢ãƒ—ãƒª: ${{ env.STAGING_APP_NAME }}"
          echo "ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³: Asia/Kolkata"
          echo "ğŸ• ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆã‚¹ã‚­ãƒƒãƒ—: ${{ github.event.inputs.skip_tests || 'false' }}"
      
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸš€ Fly.io CLI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: ğŸš€ Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œï¼ˆãƒã‚·ãƒ³è‡ªå‹•å¾©æ—§ä»˜ãï¼‰
        run: |
          echo "ğŸš€ stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒã‚·ãƒ³è‡ªå‹•å¾©æ—§æ©Ÿèƒ½ä»˜ãï¼‰ã‚’å®Ÿè¡Œã—ã¾ã™..."
          chmod +x scripts/staging/deploy-to-staging.sh
          ./scripts/staging/deploy-to-staging.sh --skip-tests --force
      
      - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ
        if: always()
        run: |
          echo "ğŸ“Š Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ"
          echo "======================================"
          echo "ğŸ• ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸ§ª å“è³ªãƒã‚§ãƒƒã‚¯: ${{ needs.quality-check.outputs.build-success == 'true' && 'âœ…' || 'âŒ' }}"
          echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ: ${{ job.status }}"
          echo ""
          echo "ğŸ”— Stagingç’°å¢ƒURL: https://${{ env.STAGING_APP_NAME }}.fly.dev"
          echo "ğŸ“Š ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
          flyctl status --app ${{ env.STAGING_APP_NAME }}
          
      - name: ğŸ’¡ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—æ¡ˆå†…
        if: success()
        run: |
          echo ""
          echo "ğŸ‰ Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo ""
          echo "ğŸ“– æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—:"
          echo "1. ğŸ§ª Stagingç’°å¢ƒã§ã®å‹•ä½œç¢ºèª"
          echo "   https://${{ env.STAGING_APP_NAME }}.fly.dev"
          echo ""
          echo "2. ğŸ” é‡è¦æ©Ÿèƒ½ã®æ‰‹å‹•ãƒ†ã‚¹ãƒˆ"
          echo "   - Discord Bot ã®åŸºæœ¬å‹•ä½œ"
          echo "   - !cost, !summary, !timezone ã‚³ãƒãƒ³ãƒ‰"
          echo ""
          echo "3. âœ… å•é¡Œãªã‘ã‚Œã° main ãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸"
          echo "   â†’ Productionç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤"