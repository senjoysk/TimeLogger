# Staging環境デプロイワークフロー
# develop ブランチの変更を staging 環境に自動デプロイ

name: Staging Deploy
on:
  push:
    branches:
      - develop
  workflow_dispatch:
    inputs:
      skip_tests:
        description: 'テストをスキップ（緊急時のみ）'
        required: false
        default: false
        type: boolean
      environment:
        description: 'デプロイ環境'
        required: true
        default: 'staging'
        type: choice
        options:
          - 'staging'

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  STAGING_APP_NAME: timelogger-staging

jobs:
  quality-check:
    runs-on: ubuntu-latest
    name: 品質チェック
    outputs:
      build-success: ${{ steps.build.outputs.success }}
      test-success: ${{ steps.test.outputs.success }}
    
    steps:
      - name: 📥 リポジトリチェックアウト
        uses: actions/checkout@v4
      
      - name: 🔧 Node.js セットアップ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: 📦 依存関係インストール
        run: npm ci
      
      - name: 🏗️ TypeScriptビルド
        id: build
        run: |
          npm run build
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: 🧪 テスト実行
        id: test
        if: github.event.inputs.skip_tests != 'true'
        run: |
          npm test
          npm run test:integration
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: 📊 テストカバレッジ確認
        if: github.event.inputs.skip_tests != 'true'
        run: npm run test:coverage

  deploy-staging:
    needs: quality-check
    if: needs.quality-check.outputs.build-success == 'true'
    runs-on: ubuntu-latest
    environment: staging
    name: Staging環境デプロイ
    
    steps:
      - name: 📊 デプロイ環境確認
        run: |
          echo "🌿 ブランチ: ${{ github.ref_name }}"
          echo "🧪 環境: staging"
          echo "📱 アプリ: ${{ env.STAGING_APP_NAME }}"
          echo "🌍 タイムゾーン: Asia/Kolkata"
          echo "🕐 デプロイ時刻: $(date)"
          echo "🧪 テストスキップ: ${{ github.event.inputs.skip_tests || 'false' }}"
      
      - name: 📥 リポジトリチェックアウト
        uses: actions/checkout@v4
      
      - name: 🚀 Fly.io CLI セットアップ
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: 🚀 Staging環境デプロイ実行（マシン自動復旧付き）
        run: |
          echo "🚀 staging環境デプロイ（マシン自動復旧機能付き）を実行します..."
          chmod +x scripts/staging/deploy-to-staging.sh
          ./scripts/staging/deploy-to-staging.sh --skip-tests --force
      
      - name: 📊 デプロイ完了レポート
        if: always()
        run: |
          echo "📊 Staging環境デプロイ完了レポート"
          echo "======================================"
          echo "🕐 デプロイ時刻: $(date)"
          echo "🌿 ブランチ: ${{ github.ref_name }}"
          echo "📝 コミット: ${{ github.sha }}"
          echo "🧪 品質チェック: ${{ needs.quality-check.outputs.build-success == 'true' && '✅' || '❌' }}"
          echo "📊 デプロイ結果: ${{ job.status }}"
          echo ""
          echo "🔗 Staging環境URL: https://${{ env.STAGING_APP_NAME }}.fly.dev"
          echo "📊 ステータス:"
          flyctl status --app ${{ env.STAGING_APP_NAME }}
          
      - name: 💡 次のステップ案内
        if: success()
        run: |
          echo ""
          echo "🎉 Staging環境デプロイが完了しました！"
          echo ""
          echo "📖 次のステップ:"
          echo "1. 🧪 Staging環境での動作確認"
          echo "   https://${{ env.STAGING_APP_NAME }}.fly.dev"
          echo ""
          echo "2. 🔍 重要機能の手動テスト"
          echo "   - Discord Bot の基本動作"
          echo "   - !cost, !summary, !timezone コマンド"
          echo ""
          echo "3. ✅ 問題なければ main ブランチにマージ"
          echo "   → Production環境への自動デプロイ"