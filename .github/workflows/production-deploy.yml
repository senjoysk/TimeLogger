# Productionç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# See https://fly.io/docs/app-guides/continuous-deployment-with-github-actions/

name: Production Deploy
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„'
        required: true
        default: false
        type: boolean
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - 'production'

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  PRODUCTION_APP_NAME: timelogger-bitter-resonance-9585

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production
    concurrency: deploy-group
    
    steps:
      - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒç¢ºèª
        run: |
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ğŸ­ ç’°å¢ƒ: production"
          echo "ğŸ“± ã‚¢ãƒ—ãƒª: ${{ env.PRODUCTION_APP_NAME }}"
          echo "ğŸŒ ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³: Asia/Tokyo"
          echo "ğŸ• ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"
          
      - name: âš ï¸ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèª
        if: github.event.inputs.confirm_production != 'true' && github.event_name == 'workflow_dispatch'
        run: |
          echo "âŒ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®ç¢ºèªãŒå¿…è¦ã§ã™"
          echo "confirm_production ã‚’ true ã«è¨­å®šã—ã¦ãã ã•ã„"
          exit 1
          
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸš€ Fly.io CLI ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: superfly/flyctl-actions/setup-flyctl@master
        
      - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
        run: |
          echo "ğŸ“Š Productionç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
          flyctl status --app ${{ env.PRODUCTION_APP_NAME }} || echo "âš ï¸ ã‚¢ãƒ—ãƒªãŒã¾ã å­˜åœ¨ã—ãªã„ã‹ã€åœæ­¢ã—ã¦ã„ã¾ã™"
          
      - name: ğŸš€ Productionç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
        run: |
          echo "ğŸš€ Productionç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’é–‹å§‹ã—ã¾ã™..."
          flyctl deploy --remote-only --app ${{ env.PRODUCTION_APP_NAME }}
          
      - name: ğŸ¥ æœ¬ç•ªãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        run: |
          echo "ğŸ¥ æœ¬ç•ªç’°å¢ƒãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
          sleep 30  # ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†å¾…æ©Ÿ
          
          for i in {1..10}; do
            if flyctl status --app ${{ env.PRODUCTION_APP_NAME }} | grep -q "started"; then
              echo "âœ… æœ¬ç•ªç’°å¢ƒãŒæ­£å¸¸ã«ç¨¼åƒã—ã¦ã„ã¾ã™"
              break
            fi
            if [ $i -eq 10 ]; then
              echo "âŒ æœ¬ç•ªç’°å¢ƒã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ"
              flyctl logs --app ${{ env.PRODUCTION_APP_NAME }}
              exit 1
            fi
            echo "â³ èµ·å‹•ç¢ºèªä¸­... ($i/10)"
            sleep 15
          done
          
      - name: ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ
        if: always()
        run: |
          echo "ğŸ“Š Productionç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ"
          echo "========================================="
          echo "ğŸ• ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚åˆ»: $(date)"
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸ“Š ãƒ‡ãƒ—ãƒ­ã‚¤çµæœ: ${{ job.status }}"
          echo ""
          flyctl status --app ${{ env.PRODUCTION_APP_NAME }}
