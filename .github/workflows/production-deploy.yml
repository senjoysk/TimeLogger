# Productionç’°å¢ƒå“è³ªãƒã‚§ãƒƒã‚¯ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼
# main ãƒ–ãƒ©ãƒ³ãƒã®å¤‰æ›´æ™‚ã«å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§æ‰‹å‹•å®Ÿè¡Œï¼‰

name: Production Quality Check
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      confirm_production:
        description: 'æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„'
        required: true
        default: false
        type: boolean
      environment:
        description: 'ãƒ‡ãƒ—ãƒ­ã‚¤ç’°å¢ƒ'
        required: true
        default: 'production'
        type: choice
        options:
          - 'production'

# æ³¨æ„: ãƒ‡ãƒ—ãƒ­ã‚¤ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§æ‰‹å‹•å®Ÿè¡Œã—ã¦ãã ã•ã„
# å®Ÿè¡Œæ–¹æ³•: ./scripts/production/deploy.sh

jobs:
  quality-check:
    runs-on: ubuntu-latest
    name: å“è³ªãƒã‚§ãƒƒã‚¯
    outputs:
      build-success: ${{ steps.build.outputs.success }}
      test-success: ${{ steps.test.outputs.success }}
    
    steps:
      - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Node.js ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci
      
      - name: ğŸ—ï¸ TypeScriptãƒ“ãƒ«ãƒ‰
        id: build
        run: |
          npm run build
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCIç’°å¢ƒæœ€é©åŒ–ï¼‰
        id: test
        env:
          CI: true
        run: |
          npm test
          npm run test:integration
          echo "success=true" >> $GITHUB_OUTPUT
      
      - name: ğŸ“Š ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸ç¢ºèª
        run: npm run test:coverage

  manual-deploy-guide:
    needs: quality-check
    if: needs.quality-check.outputs.build-success == 'true'
    runs-on: ubuntu-latest
    name: æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰
    
    steps:
      - name: ğŸ”’ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèª
        run: |
          echo "ğŸ”’ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "========================================="
          echo "ğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}"
          echo "ğŸ“ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
          echo "ğŸ• ãƒã‚§ãƒƒã‚¯æ™‚åˆ»: $(date)"
          echo "ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ: ${{ needs.quality-check.outputs.test-success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}"
          echo "ğŸ—ï¸ ãƒ“ãƒ«ãƒ‰çµæœ: ${{ needs.quality-check.outputs.build-success == 'true' && 'âœ… æˆåŠŸ' || 'âŒ å¤±æ•—' }}"
          echo ""
          echo "âš ï¸ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã¯æ‰‹å‹•ã§å®Ÿè¡Œã—ã¦ãã ã•ã„"
          
      - name: ğŸ’¡ æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤ã‚¬ã‚¤ãƒ‰
        run: |
          echo ""
          echo "ğŸš€ Productionç’°å¢ƒã¸ã®æ‰‹å‹•ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•:"
          echo "========================================="
          echo ""
          echo "1. ãƒ­ãƒ¼ã‚«ãƒ«ã§mainãƒ–ãƒ©ãƒ³ãƒã‚’pull:"
          echo "   git checkout main"
          echo "   git pull origin main"
          echo ""
          echo "2. Productionç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤:"
          echo "   ./scripts/production/deploy.sh"
          echo ""
          echo "3. ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèª:"
          echo "   - Productionç’°å¢ƒURL: https://timelogger-bitter-resonance-9585.fly.dev"
          echo "   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: https://timelogger-bitter-resonance-9585.fly.dev/health"
          echo ""
          echo "4. é‡è¦ãªå‹•ä½œãƒ†ã‚¹ãƒˆ:"
          echo "   - Discord Bot ã®åŸºæœ¬å‹•ä½œç¢ºèª"
          echo "   - å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ã‚³ãƒãƒ³ãƒ‰å‹•ä½œç¢ºèª"
          echo "   - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®æ­£å¸¸æ€§ç¢ºèª"
          echo ""
          echo "âš ï¸ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã®æ³¨æ„ç‚¹:"
          echo "   - å–¶æ¥­æ™‚é–“å¤–ã§ã®å®Ÿè¡Œã‚’æ¨å¥¨"
          echo "   - ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’äº‹å‰ã«ç¢ºèª"
          echo "   - ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®å‹•ä½œç›£è¦–ã‚’å®Ÿæ–½"
          echo ""
          echo "ğŸ” ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°:"
          echo "   - ãƒ­ã‚°ç¢ºèª: flyctl logs --app timelogger-bitter-resonance-9585"
          echo "   - ãƒã‚·ãƒ³çŠ¶æ…‹: flyctl machines list --app timelogger-bitter-resonance-9585"
          echo "   - ã‚¢ãƒ—ãƒªçŠ¶æ…‹: flyctl status --app timelogger-bitter-resonance-9585"
