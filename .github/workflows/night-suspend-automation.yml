name: å¤œé–“ã‚µã‚¹ãƒšãƒ³ãƒ‰è‡ªå‹•åŒ–

on:
  schedule:
    # å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°: 30åˆ†é–“éš”ã§å®Ÿè¡Œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œï¼‰
    - cron: '0,30 * * * *'
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
  workflow_dispatch:
    inputs:
      action:
        description: 'å®Ÿè¡Œã™ã‚‹ã‚¢ã‚¯ã‚·ãƒ§ãƒ³'
        required: true
        default: 'night-suspend'
        type: choice
        options:
          - 'night-suspend'
          - 'wake-up'
          - 'morning-recovery'

env:
  FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
  SHUTDOWN_TOKEN: ${{ secrets.SHUTDOWN_TOKEN }}
  WAKE_TOKEN: ${{ secrets.WAKE_TOKEN }}
  RECOVERY_TOKEN: ${{ secrets.RECOVERY_TOKEN }}
  FLY_APP_NAME: timelogger-bitter-resonance-9585

jobs:
  # å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°å‡¦ç†ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œï¼‰
  dynamic-schedule-check:
    if: github.event_name == 'schedule' || github.event.inputs.action == 'night-suspend' || github.event.inputs.action == 'wake-up'
    runs-on: ubuntu-latest
    name: å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
    
    steps:
      - name: â° å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‡¦ç†é–‹å§‹
        run: |
          echo "â° ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å¯¾å¿œã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™"
          echo "ç¾åœ¨æ™‚åˆ»: $(date '+%Y-%m-%d %H:%M:%S UTC')"
          echo "JST: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S')"
          echo "IST: $(TZ=Asia/Kolkata date '+%Y-%m-%d %H:%M:%S')"
          echo "EST: $(TZ=America/New_York date '+%Y-%m-%d %H:%M:%S')"
      
      - name: ğŸ“¥ Fly.io CLIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: ğŸ” ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¤å®š
        id: schedule-check
        run: |
          echo "ğŸ” ç¾åœ¨æ™‚åˆ»ã§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¤å®šã‚’å®Ÿè¡Œä¸­..."
          
          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆ
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ github.event.inputs.action }}" = "night-suspend" ]; then
              echo "SHOULD_SUSPEND=true" >> $GITHUB_OUTPUT
              echo "SHOULD_WAKE=false" >> $GITHUB_OUTPUT
              echo "MANUAL_ACTION=suspend" >> $GITHUB_OUTPUT
            elif [ "${{ github.event.inputs.action }}" = "wake-up" ]; then
              echo "SHOULD_SUSPEND=false" >> $GITHUB_OUTPUT
              echo "SHOULD_WAKE=true" >> $GITHUB_OUTPUT
              echo "MANUAL_ACTION=wake" >> $GITHUB_OUTPUT
            fi
          else
            # è‡ªå‹•å®Ÿè¡Œã®å ´åˆã¯Botã«å•ã„åˆã‚ã›
            echo "ğŸ“¡ Botã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¤å®šã‚’è¦æ±‚ä¸­..."
            
            RESPONSE=$(curl -s -w "%{http_code}" \
              -X GET \
              -H "Content-Type: application/json" \
              "https://$FLY_APP_NAME.fly.dev/api/schedule-check" \
              -o schedule_response.json || echo "000")
            
            HTTP_CODE=${RESPONSE: -3}
            
            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¤å®šå®Œäº†"
              cat schedule_response.json | jq '.'
              
              SHOULD_SUSPEND=$(cat schedule_response.json | jq -r '.shouldSuspend // false')
              SHOULD_WAKE=$(cat schedule_response.json | jq -r '.shouldWake // false')
              
              echo "SHOULD_SUSPEND=$SHOULD_SUSPEND" >> $GITHUB_OUTPUT
              echo "SHOULD_WAKE=$SHOULD_WAKE" >> $GITHUB_OUTPUT
              echo "MANUAL_ACTION=auto" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸  ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«åˆ¤å®šã®å¿œç­”: HTTP $HTTP_CODE"
              echo "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§å‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
              echo "SHOULD_SUSPEND=false" >> $GITHUB_OUTPUT
              echo "SHOULD_WAKE=false" >> $GITHUB_OUTPUT
              echo "MANUAL_ACTION=skip" >> $GITHUB_OUTPUT
            fi
          fi
      
      - name: ğŸ”„ Botã«ã‚µã‚¹ãƒšãƒ³ãƒ‰æº–å‚™è¦æ±‚
        if: steps.schedule-check.outputs.SHOULD_SUSPEND == 'true'
        run: |
          echo "ğŸ“¡ Botã«ã‚µã‚¹ãƒšãƒ³ãƒ‰æº–å‚™ã‚’è¦æ±‚ä¸­..."
          
          # Botã‚¢ãƒ—ãƒªã®ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          flyctl status -a $FLY_APP_NAME || true
          
          # Botã«ã‚µã‚¹ãƒšãƒ³ãƒ‰æº–å‚™ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
          RESPONSE=$(curl -s -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $SHUTDOWN_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"action":"prepare_suspend","trigger":"github_actions"}' \
            "https://$FLY_APP_NAME.fly.dev/api/night-suspend" \
            -o response_body.json || echo "000")
          
          HTTP_CODE=${RESPONSE: -3}
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Botã‚µã‚¹ãƒšãƒ³ãƒ‰æº–å‚™å®Œäº†"
            cat response_body.json | jq '.'
          else
            echo "âš ï¸  Botã‚µã‚¹ãƒšãƒ³ãƒ‰æº–å‚™ã®å¿œç­”: HTTP $HTTP_CODE"
            cat response_body.json 2>/dev/null || echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
          fi
      
      - name: ğŸ›‘ Fly.io ã‚¢ãƒ—ãƒªã‚µã‚¹ãƒšãƒ³ãƒ‰å®Ÿè¡Œ
        if: steps.schedule-check.outputs.SHOULD_SUSPEND == 'true'
        run: |
          echo "ğŸ›‘ Fly.io ã‚¢ãƒ—ãƒªã‚’ã‚µã‚¹ãƒšãƒ³ãƒ‰ã—ã¾ã™..."
          
          # ã‚¢ãƒ—ãƒªã®ã‚µã‚¹ãƒšãƒ³ãƒ‰å®Ÿè¡Œï¼ˆæ–°ã‚³ãƒãƒ³ãƒ‰ï¼‰
          flyctl scale count 0 -a $FLY_APP_NAME --yes
          
          # ã‚µã‚¹ãƒšãƒ³ãƒ‰ç¢ºèª
          flyctl status -a $FLY_APP_NAME
          
          echo "âœ… å¤œé–“ã‚µã‚¹ãƒšãƒ³ãƒ‰å®Œäº†"
          echo "ğŸ’¡ ã‚¢ãƒ—ãƒªã¯æœ7:00 JSTï¼ˆ22:00 UTCå‰æ—¥ï¼‰ã«è‡ªå‹•èµ·å‹•ã—ã¾ã™"

      - name: ğŸš€ Fly.io ã‚¢ãƒ—ãƒªèµ·å‹•
        if: steps.schedule-check.outputs.SHOULD_WAKE == 'true'
        run: |
          echo "ğŸš€ Fly.io ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¾ã™..."
          
          # ã‚¢ãƒ—ãƒªã®èµ·å‹•ï¼ˆæ–°ã‚³ãƒãƒ³ãƒ‰ï¼‰
          flyctl scale count 1 -a $FLY_APP_NAME --yes
          
          # èµ·å‹•ç¢ºèªï¼ˆæœ€å¤§60ç§’å¾…æ©Ÿï¼‰
          for i in {1..12}; do
            echo "â³ èµ·å‹•ç¢ºèªä¸­... ($i/12)"
            
            if flyctl status -a $FLY_APP_NAME | grep -q "started"; then
              echo "âœ… ã‚¢ãƒ—ãƒªãŒæ­£å¸¸ã«èµ·å‹•ã—ã¾ã—ãŸ"
              break
            fi
            
            if [ $i -eq 12 ]; then
              echo "âš ï¸  ã‚¢ãƒ—ãƒªã®èµ·å‹•ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™"
              flyctl logs -a $FLY_APP_NAME -n
            fi
            
            sleep 5
          done
      
      - name: ğŸ”” Botèµ·å‹•é€šçŸ¥
        if: steps.schedule-check.outputs.SHOULD_WAKE == 'true'
        run: |
          echo "ğŸ”” Botã«èµ·å‹•é€šçŸ¥ã‚’é€ä¿¡..."
          
          # Botã«èµ·å‹•é€šçŸ¥
          RESPONSE=$(curl -s -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $WAKE_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"trigger":"github_actions","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' \
            "https://$FLY_APP_NAME.fly.dev/api/wake-up" \
            -o wake_response.json || echo "000")
          
          HTTP_CODE=${RESPONSE: -3}
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Botèµ·å‹•é€šçŸ¥å®Œäº†"
            cat wake_response.json | jq '.'
          else
            echo "âš ï¸  Botèµ·å‹•é€šçŸ¥ã®å¿œç­”: HTTP $HTTP_CODE"
            cat wake_response.json 2>/dev/null || echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
          fi
      
      - name: ğŸ”„ å¤œé–“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚«ãƒãƒªå®Ÿè¡Œ
        if: steps.schedule-check.outputs.SHOULD_WAKE == 'true'
        run: |
          echo "ğŸ”„ å¤œé–“ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚«ãƒãƒªã‚’å®Ÿè¡Œ..."
          
          # è¿½åŠ ã®å¾…æ©Ÿï¼ˆã‚¢ãƒ—ãƒªãŒå®Œå…¨ã«æº–å‚™ã•ã‚Œã‚‹ã¾ã§ï¼‰
          sleep 10
          
          # ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚«ãƒãƒªå®Ÿè¡Œ
          RESPONSE=$(curl -s -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer $RECOVERY_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"trigger":"github_actions","timestamp":"'$(date -u +%Y-%m-%dT%H:%M:%SZ)'"}' \
            "https://$FLY_APP_NAME.fly.dev/api/morning-recovery" \
            -o recovery_response.json || echo "000")
          
          HTTP_CODE=${RESPONSE: -3}
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚«ãƒãƒªå®Œäº†"
            cat recovery_response.json | jq '.'
            
            # å‡¦ç†çµæœã‚’è§£æ
            PROCESSED_COUNT=$(cat recovery_response.json | jq -r '.processed_messages // 0')
            echo "ğŸ“Š å‡¦ç†ã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: $PROCESSED_COUNTä»¶"
            
            if [ "$PROCESSED_COUNT" -gt 0 ]; then
              echo "ğŸ“ å¤œé–“ã« $PROCESSED_COUNT ä»¶ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡¦ç†ã—ã¾ã—ãŸ"
            else
              echo "ğŸ“ å¤œé–“ã®æ–°è¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            fi
          else
            echo "âš ï¸  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚«ãƒãƒªã®å¿œç­”: HTTP $HTTP_CODE"
            cat recovery_response.json 2>/dev/null || echo "ãƒ¬ã‚¹ãƒãƒ³ã‚¹æœ¬æ–‡ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            
            # ã‚¨ãƒ©ãƒ¼ã®å ´åˆã§ã‚‚ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã¯ç¶™ç¶šï¼ˆéƒ¨åˆ†çš„æˆåŠŸã¨ã—ã¦æ‰±ã†ï¼‰
            echo "ğŸ’¡ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚«ãƒãƒªã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€ã‚¢ãƒ—ãƒªã¯æ­£å¸¸ã«èµ·å‹•ã—ã¦ã„ã¾ã™"
          fi
      
      - name: ğŸ“‹ å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‡¦ç†å®Œäº†ã‚µãƒãƒªãƒ¼
        run: |
          echo "ğŸ“‹ å‹•çš„ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å‡¦ç†å®Œäº†ã‚µãƒãƒªãƒ¼"
          echo "=================================="
          echo "ğŸ• å®Œäº†æ™‚åˆ»: $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"
          echo "â° å®Ÿè¡Œåˆ¤å®š:"
          echo "  - ã‚µã‚¹ãƒšãƒ³ãƒ‰: ${{ steps.schedule-check.outputs.SHOULD_SUSPEND }}"
          echo "  - èµ·åºŠ: ${{ steps.schedule-check.outputs.SHOULD_WAKE }}"
          echo "  - ãƒ¢ãƒ¼ãƒ‰: ${{ steps.schedule-check.outputs.MANUAL_ACTION }}"
          
          if [ "${{ steps.schedule-check.outputs.SHOULD_SUSPEND }}" = "true" ]; then
            echo "ğŸ›‘ ã‚µã‚¹ãƒšãƒ³ãƒ‰å®Ÿè¡Œ: âœ…"
          fi
          
          if [ "${{ steps.schedule-check.outputs.SHOULD_WAKE }}" = "true" ]; then
            echo "ğŸš€ ã‚¢ãƒ—ãƒªèµ·å‹•: âœ…"
            echo "ğŸ”” èµ·å‹•é€šçŸ¥: $([ -f wake_response.json ] && echo 'âœ…' || echo 'âš ï¸')"
            echo "ğŸ”„ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚«ãƒãƒª: $([ -f recovery_response.json ] && echo 'âœ…' || echo 'âš ï¸')"
          fi
          
          # æœ€çµ‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
          echo ""
          echo "ğŸ“Š æœ€çµ‚ã‚¢ãƒ—ãƒªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:"
          flyctl status -a $FLY_APP_NAME

  # æ‰‹å‹•å®Ÿè¡Œç”¨ã®å€‹åˆ¥ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
  manual-action:
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.action != 'night-suspend' && github.event.inputs.action != 'wake-up'
    runs-on: ubuntu-latest
    name: æ‰‹å‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
    
    steps:
      - name: ğŸ“¥ Fly.io CLIã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: ğŸ”§ æ‰‹å‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
        run: |
          echo "ğŸ”§ æ‰‹å‹•ã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${{ github.event.inputs.action }}"
          
          case "${{ github.event.inputs.action }}" in
            "morning-recovery")
              echo "ğŸ”„ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒªã‚«ãƒãƒªã®ã¿å®Ÿè¡Œ..."
              
              curl -X POST \
                -H "Authorization: Bearer $RECOVERY_TOKEN" \
                -H "Content-Type: application/json" \
                -d '{"trigger":"manual_github_actions"}' \
                "https://$FLY_APP_NAME.fly.dev/api/morning-recovery"
              ;;
            *)
              echo "âŒ ä¸æ˜ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³: ${{ github.event.inputs.action }}"
              exit 1
              ;;
          esac