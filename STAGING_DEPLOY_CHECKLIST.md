# Stagingç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

## ğŸš¨ é‡è¦: suspendæ©Ÿèƒ½å‰Šé™¤ã«ã‚ˆã‚‹stagingç’°å¢ƒã¸ã®å½±éŸ¿

### ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã®æº–å‚™

#### 1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®æœ€çµ‚ç¢ºèª
- [x] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰æˆåŠŸ (`npm run build`)
- [x] ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆæˆåŠŸ (`npm test`)
- [x] ãƒ­ãƒ¼ã‚«ãƒ«ã§Devç’°å¢ƒæ­£å¸¸å‹•ä½œç¢ºèª

#### 2. ç’°å¢ƒå¤‰æ•°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
- [x] `.env.staging`ã‹ã‚‰suspendé–¢é€£å¤‰æ•°å‰Šé™¤æ¸ˆã¿
- [x] `.env.production`ã‹ã‚‰suspendé–¢é€£å¤‰æ•°å‰Šé™¤æ¸ˆã¿
- [ ] **Fly.io secretså‰Šé™¤** (ãƒ‡ãƒ—ãƒ­ã‚¤å‰ã«å®Ÿè¡Œ)

```bash
# Fly.io secretsã‚’ç¢ºèªãƒ»å‰Šé™¤
fly secrets list --app timelogger-staging
fly secrets unset SHUTDOWN_TOKEN WAKE_TOKEN RECOVERY_TOKEN --app timelogger-staging
```

#### 3. GitHub Actionsç¢ºèª
- [x] `night-suspend-automation.yml` å‰Šé™¤æ¸ˆã¿
- [ ] GitHub Secretsã‚’å‰Šé™¤ (æ‰‹å‹•)
  - `SHUTDOWN_TOKEN`
  - `WAKE_TOKEN` 
  - `RECOVERY_TOKEN`

### ãƒ‡ãƒ—ãƒ­ã‚¤æ‰‹é †

#### Phase 1: Stagingç’°å¢ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç§»è¡Œ
```bash
# 1. stagingç’°å¢ƒã«æ¥ç¶š
fly ssh console --app timelogger-staging

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
cp /data/app.db /data/app.db.backup-$(date +%Y%m%d_%H%M%S)

# 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
sqlite3 /data/app.db < staging_migration.sql

# 4. æ¥ç¶šçµ‚äº†
exit
```

#### Phase 2: ã‚³ãƒ¼ãƒ‰ãƒ‡ãƒ—ãƒ­ã‚¤
```bash
# 1. developãƒ–ãƒ©ãƒ³ãƒã«push (è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤)
git push origin develop

# 2. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ­ã‚°ç›£è¦–
fly logs --app timelogger-staging

# 3. ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
fly status --app timelogger-staging
```

### ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®æ¤œè¨¼

#### 1. ã‚·ã‚¹ãƒ†ãƒ èµ·å‹•ç¢ºèª
- [ ] ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ­£å¸¸èµ·å‹•
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šæˆåŠŸ
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãªã—

#### 2. Discord Botå‹•ä½œç¢ºèª
- [ ] Discord BotãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³çŠ¶æ…‹
- [ ] DMã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡å¯èƒ½
- [ ] åŸºæœ¬ã‚³ãƒãƒ³ãƒ‰å‹•ä½œç¢ºèª:
  - [ ] é€šå¸¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¨˜éŒ²
  - [ ] `!help` ã‚³ãƒãƒ³ãƒ‰
  - [ ] `!summary` ã‚³ãƒãƒ³ãƒ‰
  - [ ] `!logs` ã‚³ãƒãƒ³ãƒ‰
  - [ ] `!cost` ã‚³ãƒãƒ³ãƒ‰

#### 3. å‰Šé™¤æ©Ÿèƒ½ã®ç¢ºèª
- [ ] `!suspend-schedule` ã‚³ãƒãƒ³ãƒ‰ãŒå­˜åœ¨ã—ãªã„
- [ ] suspendé–¢é€£ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãªã„
- [ ] GitHub Actions workflowæœªå®Ÿè¡Œ

### å•é¡Œç™ºç”Ÿæ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

#### ç·Šæ€¥æ™‚ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
```bash
# 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
fly ssh console --app timelogger-staging
cp /data/app.db.backup-[æœ€æ–°æ—¥æ™‚] /data/app.db
exit

# 2. ã‚³ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
git revert HEAD
git push origin develop

# 3. ç’°å¢ƒå¤‰æ•°å¾©å…ƒ (å¿…è¦ãªå ´åˆ)
fly secrets set SHUTDOWN_TOKEN="..." --app timelogger-staging
```

### äºˆæƒ³ã•ã‚Œã‚‹å•é¡Œã¨å¯¾ç­–

#### å•é¡Œ1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼
**ç—‡çŠ¶**: `SQLITE_ERROR: no such table: suspend_states`
**å¯¾ç­–**: staging_migration.sqlã‚’å†å®Ÿè¡Œ

#### å•é¡Œ2: ç’°å¢ƒå¤‰æ•°å‚ç…§ã‚¨ãƒ©ãƒ¼
**ç—‡çŠ¶**: `process.env.SHUTDOWN_TOKEN is undefined`
**å¯¾ç­–**: å‰Šé™¤ã—ãŸsuspendé–¢é€£ã‚³ãƒ¼ãƒ‰ã¸ã®å‚ç…§ãŒæ®‹ã£ã¦ã„ãªã„ã‹ç¢ºèª

#### å•é¡Œ3: Discord Botèµ·å‹•å¤±æ•—
**ç—‡çŠ¶**: æ´»å‹•è¨˜éŒ²ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼
**å¯¾ç­–**: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã®æ•´åˆæ€§ç¢ºèª

### æˆåŠŸåŸºæº–

- âœ… Stagingç’°å¢ƒã§Discord Botæ­£å¸¸å‹•ä½œ
- âœ… ä¸»è¦ã‚³ãƒãƒ³ãƒ‰ã™ã¹ã¦æ­£å¸¸å‹•ä½œ
- âœ… suspendæ©Ÿèƒ½å®Œå…¨å‰Šé™¤ç¢ºèª
- âœ… ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãªã—
- âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åŠ£åŒ–ãªã—

### æ³¨æ„äº‹é …

1. **ãƒ‡ãƒ¼ã‚¿æ¶ˆå¤±ã®å¯èƒ½æ€§**: suspendé–¢é€£ãƒ‡ãƒ¼ã‚¿ï¼ˆæœªä½¿ç”¨ã®ãŸã‚å½±éŸ¿ãªã—ï¼‰
2. **ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã®çŸ­æ™‚é–“åœæ­¢
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿**: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯å½±éŸ¿ãªã—ï¼ˆsuspendæ©Ÿèƒ½æœªä½¿ç”¨ã®ãŸã‚ï¼‰

### é€£çµ¡å…ˆ

å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã¯ä»¥ä¸‹ã§å¯¾å¿œï¼š
- ã‚³ãƒ¼ãƒ‰ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: Gitæ“ä½œ
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å¾©å…ƒ
- ç’°å¢ƒå¤‰æ•°å¾©å…ƒ: Fly.io secretsè¨­å®š